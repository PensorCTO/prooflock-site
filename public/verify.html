<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProofLock Verification</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #e0e0e0;
            --accent-color: #00D26A;
            --border-color: #333;
            --success-color: #00D26A;
            --fail-color: #ff3333;
            --warning-color: #ffaa33;
        }
        body {
            margin: 0; padding-top: 80px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: url('assets/background_art.jpg') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; text-align: center;
        }
        /* GLOBAL NAV */
        .global-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(10px);
            z-index: 1000; display: flex; align-items: center; padding: 0 40px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-brand { font-size: 1.5rem; font-weight: 900; color: #fff; text-decoration: none; margin-right: auto; }
        .nav-brand .brand-lock { color: #00D26A; }
        .nav-links { display: flex; gap: 30px; position: absolute; left: 50%; transform: translateX(-50%); }
        .nav-links a { color: #fff; text-decoration: none; font-weight: 500; font-size: 0.95rem; }
        .nav-links a:hover { color: #00D26A; }
        @media (max-width: 768px) { .nav-links { display: none; } }
        
        /* CONTAINER */
        .verify-container {
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--border-color);
            padding: 40px; border-radius: 16px;
            max-width: 500px; width: 90%;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        input[type="text"] {
            width: 100%; padding: 15px; box-sizing: border-box;
            background: #000; border: 1px solid var(--border-color);
            border-radius: 8px; color: var(--accent-color);
            font-family: monospace; font-size: 14px; margin-bottom: 20px; outline: none;
        }
        button {
            width: 100%; padding: 15px; background: var(--accent-color);
            color: #000; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
        }
        #result-area { display: none; margin-top: 25px; padding: 20px; background: rgba(0,0,0,0.4); text-align: left; border-radius: 8px; }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .value { color: #fff; font-family: monospace; font-size: 13px; word-break: break-all; }
        .verified-badge { text-align: center; padding: 8px; border-radius: 4px; font-weight: bold; margin-bottom: 15px; }
        
        /* FOOTER */
        footer { background: #000; padding: 40px 20px; margin-top: auto; width: 100%; border-top: 1px solid #222; }
        footer a { color: #888; text-decoration: none; margin: 0 10px; font-size: 14px; }
    </style>
</head>
<body>
    <nav class="global-nav">
        <a href="index.html" class="nav-brand">Proof<span class="brand-lock">Lock</span></a>
        <div class="nav-links">
            <a href="index.html">Home</a> <a href="verify.html">Verify</a> <a href="decrypt.html">Decrypt</a> <a href="support.html">Support</a>
        </div>
    </nav>

    <div class="verify-container">
        <div style="font-size: 40px; margin-bottom: 15px;">üõ°Ô∏è</div>
        <h1>Verify Integrity</h1>
        <p style="color:#888; margin-bottom:30px;">Confirm asset status on the public ledger.</p>

        <input type="text" id="hashInput" placeholder="Paste Asset Hash..." />
        <button onclick="handleVerify()" id="verifyBtn">Verify Ledger</button>

        <div id="result-area">
            <div id="statusBadge" class="verified-badge">--</div>
            <div class="status-row"><span style="color:#888; font-size:11px;">Asset Name</span><span class="value" id="resName">--</span></div>
            <div class="status-row"><span style="color:#888; font-size:11px;">Timestamp</span><span class="value" id="resTime">--</span></div>
            <div class="status-row"><span style="color:#888; font-size:11px;">Ledger TX</span><span class="value" id="resTx">--</span></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fefudeppzrrsipwzoqcr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_876h9RnxuswzMrLWVY-baw_K4XZUWaR';
        
        let supabaseClient;

        document.addEventListener('DOMContentLoaded', () => {
            console.log("ProofLock Verify v2.3 Loaded"); 
            
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
            const params = new URLSearchParams(window.location.search);
            const hash = params.get('hash');
            if (hash) {
                document.getElementById('hashInput').value = hash;
                handleVerify(hash);
            }
        });

        async function handleVerify(passedHash = null) {
            const input = document.getElementById('hashInput');
            const btn = document.getElementById('verifyBtn');
            const resultArea = document.getElementById('result-area');
            
            const rawHash = passedHash || input.value;
            const hash = rawHash ? rawHash.trim().toLowerCase() : '';
            if(!hash || !supabaseClient) return;

            btn.innerText = "Scanning...";
            btn.disabled = true;
            resultArea.style.display = "none";

            try {
                console.log('[Verify] Hash:', hash);

                // STRATEGY v2.3: Sequential Check
                // This completely bypasses the .or() raw string parser issues.
                // It uses standard .eq() which is type-safe and handles hashes starting with numbers automatically.
                
                // 1. Check Asset Hash first
                let { data, error } = await supabaseClient
                    .from('proof_ledger')
                    .select('asset_name, created_at, transaction_hash')
                    .eq('asset_hash', hash) // Safe method
                    .maybeSingle();

                // 2. If not found (and no error), check Transaction Hash
                if (!data && !error) {
                    console.log('[Verify] Asset Hash miss. Checking Transaction Hash...');
                    const txResult = await supabaseClient
                        .from('proof_ledger')
                        .select('asset_name, created_at, transaction_hash')
                        .eq('transaction_hash', hash) // Safe method
                        .maybeSingle();
                    
                    data = txResult.data;
                    error = txResult.error;
                }

                if (error) { throw error; }

                if (!data) {
                    resultArea.style.display = "block";
                    document.getElementById('statusBadge').innerText = "RECORD NOT FOUND";
                    document.getElementById('statusBadge').style.background = "#ffaa33";
                    document.getElementById('resName').innerText = "No matching record found";
                    document.getElementById('resTime').innerText = "--";
                    document.getElementById('resTx').innerText = "--";
                    return;
                }

                document.getElementById('statusBadge').innerText = "VERIFIED VALID";
                document.getElementById('statusBadge').style.background = "#00D26A";
                document.getElementById('resName').innerText = data.asset_name || "Confidential";
                document.getElementById('resTime').innerText = new Date(data.created_at).toLocaleString();
                const tx = data.transaction_hash || "Pending";
                document.getElementById('resTx').innerHTML = tx.startsWith('0x') 
                    ? `<a href="https://polygonscan.com/tx/${tx}" target="_blank" style="color:#00D26A; text-decoration:underline;">${tx.substring(0,16)}... ‚Üó</a>` 
                    : tx;
                resultArea.style.display = "block";

            } catch (err) {
                console.error('[Verify] Error:', err);
                resultArea.style.display = "block";
                document.getElementById('statusBadge').innerText = "CONNECTION ERROR";
                document.getElementById('statusBadge').style.background = "#ff3333";
                document.getElementById('resName').innerText = "System Error";
                document.getElementById('resTime').innerText = err.code || "Unknown";
                document.getElementById('resTx').innerText = err.message;
            } finally {
                btn.innerText = "Verify Ledger";
                btn.disabled = false;
            }
        }
    </script>

    <footer>
        <div style="margin-bottom: 20px;">
            <a href="index.html">Home</a> <a href="verify.html">Verify</a> <a href="privacy.html">Privacy</a> <a href="terms.html">Terms</a> <a href="support.html">Support</a>
        </div>
        <div style="color: #444; font-size: 12px;">
            &copy; 2025 ProofLock LLC. (v2.3) <br>
            Patent Pending.
        </div>
    </footer>
</body>
</html>